<Project>
	<UsingTask TaskName="CqlToCSharp" AssemblyFile="..\lib\net8.0\Hl7.Cql.Tools.BuildTasks.dll"/>
	<ItemGroup>
		<CqlFiles Include="**\*.cql" />
		<GeneratedCSharp Include="**\*.cql.cs"/>
		<Compile Update="@(GeneratedCSharp)" DependentUpon="%(Filename)" />
	</ItemGroup>

	<!-- Visual Studio builds with MSBuild.  Just use dotnet build in that case. -->
	<Target BeforeTargets="Build" Name="RunCqlToCSharp" Condition="'$(MSBuildRuntimeType)' != 'Core'">
		<Exec ConsoleToMsBuild="true" Command="dotnet build -t:CqlToCSharp" />
	</Target>
	
	<Target BeforeTargets="CoreCompile" Name="CqlToCSharp" Condition="'$(MSBuildRuntimeType)' == 'Core'">
		<CqlToCSharp Sources="@(CqlFiles)" ElmPath="$(MSBuildProjectDirectory)/obj" Namespace="$(RootNamespace)">
			<Output TaskParameter="Elm" PropertyName="ELMFile" />
			<Output TaskParameter="CSharp" PropertyName="CSharpFile" />
		</CqlToCSharp>		
	</Target>

	<Target AfterTargets="Clean" Name="BeforeClean">
		<ItemGroup>
			<FilesToDelete Include="$(MSBuildProjectDirectory)\**\*.cql.json" />
			<FilesToDelete Include="$(MSBuildProjectDirectory)\**\*.cql.cs" />
		</ItemGroup>
		<Delete Files="@(FilesToDelete)" />
	</Target>
</Project>