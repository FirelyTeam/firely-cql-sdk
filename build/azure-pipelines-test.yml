# Repo: FirelyTeam/Cql-sdk
# File: build/azure-pipelines.yml
name: build-$(Date:yyyyMMdd)$(Rev:-r)
resources:
  repositories:
    - repository: templates
      type: github
      name: FirelyTeam/azure-pipeline-templates
      endpoint: FirelyTeam 

variables:
  - group: CodeSigning
  - group: APIKeys
  - template: variables.yml  

pool: 
  vmImage: $(vmImage)

trigger:
  branches: 
    include:
    - devops/exclude-docs-folder
  paths:
    exclude:
    - 'docs/*'

stages:
- stage: checkForDocChanges
  jobs:
    - job: CheckDocChanges
      displayName: 'Check for changes outside docs folder'
      pool: 
        vmImage: ubuntu-latest
      steps:
        - checkout: self
          fetchDepth: 0 
        - script: |
            echo "##vso[task.setvariable variable=SOURCE_BRANCH]$(Build.SourceBranch)"
            echo "##vso[task.setvariable variable=TARGET_BRANCH]$(System.PullRequest.TargetBranch)"
            echo "build source name: $(Build.Repository.Name)"
            echo "build source ref: $(Build.SourceBranch)"
            echo "build source version: $(Build.SourceVersion)"
            echo "PR source branch: $(System.PullRequest.SourceBranch)"
            echo "PR target branch: $(System.PullRequest.TargetBranch)"
        - script: |
            echo "##[group]Checking for changes outside docs folder"
            # Check if we are in a PR build or normal branch build
            if [ "$(System.PullRequest.SourceBranch)" != "" ]; then
              # PR build: compare source branch with target branch (e.g., main)
              CHANGED_FILES=$(git diff --name-only origin/$(TARGET_BRANCH) $(SOURCE_BRANCH))
              echo "Checking changes between $(TARGET_BRANCH) and $(SOURCE_BRANCH) results in the following files: $(CHANGED_FILES)"
            else
              # Branch build: compare current commit with previous commit
              git fetch origin $(Build.SourceBranch) --depth=2
              CHANGED_FILES=$(git diff --name-only HEAD^1 HEAD)
            fi

            # Check if any files outside the /docs/ folder changed
            if echo "$CHANGED_FILES" | grep -v '^docs/'; then
              echo "##[endgroup]"
              echo "##vso[task.setvariable variable=skipBuildStage]false"
            else
              echo "##[endgroup]"
              echo "##vso[task.setvariable variable=skipBuildStage]true"
            fi
          displayName: 'Check if non-docs files were changed'
        - powershell: |
            if ($(skipBuildStage) -eq 'true') {
              Write-Host "Only /docs/ files changed, skipping build."
            } else {
              Write-Host "Changes outside /docs/ detected, proceeding with build."
            }
            # Explicitly set exit 0 to prevent the script from failing
            exit 0
          displayName: 'Output change detection result'

- stage: build
  condition: and(succeeded(), ne(variables['skipBuildStage'], 'true'))
  jobs:
  - ${{ if not(startswith(variables['Build.SourceBranch'], 'refs/tags/v')) }}:  # 'normal' build 
    - template: templates/build.yml  # Template reference
      parameters:
        dotNetCoreVersion: $(DOTNET_CORE_SDK)
        useVersionSuffix: true
        packageArtifacts: true
        restoreDependencies: true
        nuGetServiceConnections: GitHubPackageGetFeed
        nuGetSources: --source https://nuget.pkg.github.com/FirelyTeam/index.json
        pool: 
          vmImage: $(vmImage)
    
  - ${{ if startswith(variables['Build.SourceBranch'], 'refs/tags/v') }}:  # release mode
    - template: templates/build.yml  # Template reference
      parameters:
        dotNetCoreVersion: $(DOTNET_CORE_SDK)
        useVersionSuffix: false
        packageArtifacts: true
        restoreDependencies: true
        pool: 
          vmImage: $(vmImage)